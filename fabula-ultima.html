
<html>
  <head>
    <link href="fabula-ultima.css" rel="stylesheet" type="text/css"/>
  </head>
  <body>
    <input class="chimera-hidden" name="attr_sheet_type" type="hidden" value="bestiary"/>
    <div class="fabula-ultima">
      <div class="chimera-input sheet-type chimera-input--flex-row chimera-input--nowrap">
        <label class="chimera-input__label" data-i18n="sheet_type" for="sheet_type">Sheet Type</label>
        <select class="chimera-input__field" data-i18n-title="sheet_type_title" id="sheet_type" name="attr_sheet_type" title="Sheet Type">
          <option data-i18n="character" selected="selected" value="character">Character</option>
          <option data-i18n="bestiary" selected="selected" value="bestiary">Bestiary</option>
          <option data-i18n="gm" value="gm">GM</option>
        </select>
      </div>
      <main class="character"><span>[CHARACTER]</span></main>
      <main class="bestiary">
      </main>
      <main class="gm"><span>[GM]</span></main>
      <footer></footer>
    </div>
    <script type="text/worker">var __spreadArray = (this && this.__spreadArray) || function (to, from, pack) {
    if (pack || arguments.length === 2) for (var i = 0, l = from.length, ar; i < l; i++) {
        if (ar || !(i in from)) {
            if (!ar) ar = Array.prototype.slice.call(from, 0, i);
            ar[i] = from[i];
        }
    }
    return to.concat(ar || Array.prototype.slice.call(from));
};
var G_REPEATING = [
    'bonds',
    'attacks',
    'weapons',
    'spells',
    'notes',
    'specials',
    'actions',
    'rare-gear',
];
var G_DIE_SIZES = [6, 8, 10, 12];
var G_STATUS_EFFECTS = {
    dazed: ['insight'],
    enraged: ['dexterity', 'insight'],
    poisoned: ['might', 'willpower'],
    shaken: ['willpower'],
    slow: ['dexterity'],
    weak: ['might'],
};
var G_STAT_UPDATES = {
    dexterity: ['dexterity_max', 'poisoned', 'dazed', 'enraged', 'slow'],
    insight: ['insight_max', 'poisoned', 'dazed', 'enraged', 'slow'],
    might: ['might_max', 'poisoned', 'dazed', 'enraged', 'slow'],
    willpower: ['willpower_max', 'poisoned', 'dazed', 'enraged', 'slow'],
    hp: ['sheet_type', 'might_max', 'level', 'hp_extra'],
    mp: ['sheet_type', 'willpower_max', 'level', 'mp_extra'],
    initiative: ['dexterity', 'insight', 'initiative_extra', 'initiative_bonus'],
    defense: [
        'dexterity',
        'defense_quick',
        'defense_extra',
        'armor_is_martial',
        'armor_defense',
        'armor_defense_bonus',
        'shield_defense_bonus',
    ],
    magic_defense: [
        'willpower',
        'defense_quick',
        'magic_defense_extra',
        'armor_magic_defense_bonus',
        'shield_magic_defense_bonus',
    ],
};
var listenersByKey = function (obj) {
    return Object.entries(obj).reduce(function (memo, _a) {
        var key = _a[0], arr = _a[1];
        memo[key] = arr.map(function (str) { return "change:".concat(str); }).join(' ');
        return memo;
    }, {});
};
var listeners = function (arr) {
    return arr.map(function (str) { return "change:".concat(str); }).join(' ');
};
var RepeatingModule = (function () {
    function RepeatingModule() {
    }
    RepeatingModule.isFieldsetEmpty = function (section, suffix) {
        if (suffix === void 0) { suffix = 'empty'; }
        console.log('isFieldsetEmpty');
        getSectionIDs(section, function (id) {
            var _a, _b;
            console.log((_a = {}, _a["".concat(section, "_").concat(suffix)] = id.length, _a));
            setAttrs((_b = {}, _b["".concat(section, "_").concat(suffix)] = id.length, _b));
        });
    };
    RepeatingModule.prototype.getRepID = function (sourceAttribute) {
        sourceAttribute.split('_').at(2);
    };
    return RepeatingModule;
}());
G_REPEATING.forEach(function (fieldset) {
    on("sheet:opened change:repeating_".concat(fieldset, " remove:repeating_").concat(fieldset), function (eventInfo) {
        console.log('REPEATING');
        RepeatingModule.isFieldsetEmpty(fieldset);
    });
});
on('change:defense_quick', function (eventInfo) {
    calculateQuickDefenses(eventInfo.newValue);
});
on('change:defense_extra change:magic_defense_extra', function () {
    updateQuickDefenseDropdown();
});
Object.keys(G_STAT_UPDATES).forEach(function (attr) {
    on(listeners(G_STAT_UPDATES[attr]), function () {
        switch (attr) {
            case 'dexterity':
            case 'insight':
            case 'might':
            case 'willpower':
                return calculateAttribute(attr, G_STAT_UPDATES[attr]);
            case 'hp':
                return calculateMaxHP(G_STAT_UPDATES[attr]);
            case 'mp':
                return calculateMaxMP(G_STAT_UPDATES[attr]);
            case 'initiative':
                return calculateInitiative(G_STAT_UPDATES[attr]);
            case 'defense':
                return calculateDefense(G_STAT_UPDATES[attr]);
            case 'magic_defense':
                return calculateMagicDefense(G_STAT_UPDATES[attr]);
        }
    });
});
var calculateAttribute = function (attr, request) {
    getAttrs(request, function (v) {
        var _a;
        var _b;
        var die = (_b = +v["".concat(attr, "_max")]) !== null && _b !== void 0 ? _b : 0;
        setAttrs((_a = {}, _a[attr] = die, _a), { silent: true });
    });
};
var calculateStatusEffects = function (v) { };
var calculateMaxHP = function (request) {
    getAttrs(request, function (v) {
        var _a, _b, _c;
        console.group('calculcalculateMaxHPateHP');
        console.log(request);
        console.log(v);
        var might_max = (_a = +v.might_max) !== null && _a !== void 0 ? _a : 0;
        var level = (_b = +v.level) !== null && _b !== void 0 ? _b : 0;
        var hp_extra = (_c = +v.hp_extra) !== null && _c !== void 0 ? _c : 0;
        var hp_max;
        if (v.sheet_type === 'character') {
            hp_max = might_max * 5 + level + hp_extra;
        }
        if (v.sheet_type === 'bestiary') {
            hp_max = might_max * 5 + level * 2 + hp_extra;
        }
        var hp_crisis = Math.floor(hp_max / 2);
        console.log('save:', { hp_max: hp_max, hp_crisis: hp_crisis });
        setAttrs({ hp_max: hp_max, hp_crisis: hp_crisis }, { silent: true });
        console.groupEnd();
    });
};
var calculateMaxMP = function (request) {
    getAttrs(request, function (v) {
        var _a, _b, _c;
        console.group('calculateMaxMP');
        console.log(request);
        console.log(v);
        var willpower_max = (_a = +v.willpower_max) !== null && _a !== void 0 ? _a : 0;
        var level = (_b = +v.level) !== null && _b !== void 0 ? _b : 0;
        var mp_extra = (_c = +v.mp_extra) !== null && _c !== void 0 ? _c : 0;
        var mp_max;
        if (v.sheet_type === 'character') {
            mp_max = willpower_max * 5 + level;
        }
        if (v.sheet_type === 'bestiary') {
            mp_max = willpower_max * 5 + level + mp_extra;
        }
        console.log('save:', { mp_max: mp_max });
        setAttrs({ mp_max: mp_max }, { silent: true });
        console.groupEnd();
    });
};
var calculateDefense = function (request) {
    getAttrs(request, function (v) {
        var _a, _b, _c, _d, _e;
        console.group('calculateDefenses');
        console.log(request);
        console.log(v);
        var dexterity = (_a = +v.dexterity) !== null && _a !== void 0 ? _a : 0;
        var defense_extra = (_b = +v.defense_extra) !== null && _b !== void 0 ? _b : 0;
        var is_martial = v.armor_is_martial === 'on';
        var armor_defense = (_c = +v.armor_defense) !== null && _c !== void 0 ? _c : 0;
        var armor_defense_bonus = (_d = +v.armor_defense_bonus) !== null && _d !== void 0 ? _d : 0;
        var shield_defense_bonus = (_e = +v.shield_defense_bonus) !== null && _e !== void 0 ? _e : 0;
        var defense = (is_martial ? armor_defense : dexterity + armor_defense_bonus) +
            shield_defense_bonus +
            defense_extra;
        setAttrs({ defense: defense }, { silent: true });
        console.log('save:', { defense: defense });
        console.groupEnd();
    });
};
var calculateMagicDefense = function (request) {
    getAttrs(request, function (v) {
        var _a, _b, _c, _d;
        console.group('calculateMagicDefense');
        console.log(request);
        console.log(v);
        var willpower = (_a = +v.willpower) !== null && _a !== void 0 ? _a : 0;
        var magic_defense_extra = (_b = +v.magic_defense_extra) !== null && _b !== void 0 ? _b : 0;
        var armor_magic_defense_bonus = (_c = +v.armor_magic_defense_bonus) !== null && _c !== void 0 ? _c : 0;
        var shield_magic_defense_bonus = (_d = +v.shield_magic_defense_bonus) !== null && _d !== void 0 ? _d : 0;
        var magic_defense = willpower + armor_magic_defense_bonus + shield_magic_defense_bonus + magic_defense_extra;
        setAttrs({ magic_defense: magic_defense }, { silent: true });
        console.log('save:', { magic_defense: magic_defense });
        console.groupEnd();
    });
};
var calculateQuickDefenses = function (value) {
    if (!value)
        return;
    var _a = value.split('/'), def = _a[0], mdef = _a[1];
    console.log({ def: def, mdef: mdef });
    setAttrs({
        defense_extra: def,
        magic_defense_extra: mdef,
    }, { silent: true });
};
var updateQuickDefenseDropdown = function () {
    getAttrs(['defense_extra', 'magic_defense_extra'], function (v) {
        var defense_quick = "".concat(v.defense_extra, "/").concat(v.magic_defense_extra);
        setAttrs({ defense_quick: defense_quick }, { silent: true });
    });
};
var calculateInitiative = function (request) {
    getAttrs(__spreadArray(['sheet_type'], request, true), function (v) {
        var _a, _b, _c, _d;
        var dexterity = (_a = +v.dexterity) !== null && _a !== void 0 ? _a : 0;
        var insight = (_b = +v.insight) !== null && _b !== void 0 ? _b : 0;
        var initiative_bonus = (_c = +v.initiative_bonus) !== null && _c !== void 0 ? _c : 0;
        var initiative_extra = (_d = +v.initiative_extra) !== null && _d !== void 0 ? _d : 0;
        var initiative;
        if (v.sheet_type === 'character') {
        }
        if (v.sheet_type === 'bestiary') {
            initiative = (dexterity + insight) / 2 + initiative_bonus + initiative_extra;
        }
        console.log({ initiative: initiative });
        setAttrs({ initiative: initiative }, { silent: true });
    });
};

    </script>
  </body>
</html>